version: '3.8'

services:
  # Frontend Next.js
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    expose:
      - "3000"
    environment:
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY=${NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY}
      - NODE_ENV=production
    depends_on:
      - backend
      - redis
    restart: unless-stopped

  # Backend Fastify
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    expose:
      - "4000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-4000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - N8N_BASE_URL=${N8N_BASE_URL}
      - N8N_WEBHOOK_CAMPAIGN_SEND=${N8N_WEBHOOK_CAMPAIGN_SEND}
      - N8N_WEBHOOK_WHATSAPP_REPLY=${N8N_WEBHOOK_WHATSAPP_REPLY}
      - N8N_WEBHOOK_WHATSAPP_AUTH=${N8N_WEBHOOK_WHATSAPP_AUTH}
      - N8N_WEBHOOK_CREATE_AD_GROUP=${N8N_WEBHOOK_CREATE_AD_GROUP}
      - N8N_WEBHOOK_BILLING=${N8N_WEBHOOK_BILLING}
      - N8N_WEBHOOK_MERCADOPAGO=${N8N_WEBHOOK_MERCADOPAGO}
      - N8N_WEBHOOK_HEALTH=${N8N_WEBHOOK_HEALTH}
      - WHATSAPP_BASE_URL=${WHATSAPP_BASE_URL}
      - WHATSAPP_TOKEN=${WHATSAPP_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_WEBHOOK_VERIFY_TOKEN}
      - MERCADOPAGO_ACCESS_TOKEN=${MERCADOPAGO_ACCESS_TOKEN}
      - MERCADOPAGO_PUBLIC_KEY=${MERCADOPAGO_PUBLIC_KEY}
      - MERCADOPAGO_WEBHOOK_SECRET=${MERCADOPAGO_WEBHOOK_SECRET}
      - META_APP_ID=${META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
      - META_REDIRECT_URI=${META_REDIRECT_URI}
      - META_LONG_LIVED_TOKEN_SECRET=${META_LONG_LIVED_TOKEN_SECRET}
      - REDIS_URL=redis://redis:6379
      - JWT_SIGNING_KEY=${JWT_SIGNING_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - QUEUE_PREFIX=${QUEUE_PREFIX:-ondeclick}
      - FEATURE_TIKTOK_ENABLED=${FEATURE_TIKTOK_ENABLED:-false}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-200}
      - RATE_LIMIT_TIME_WINDOW_MS=${RATE_LIMIT_TIME_WINDOW_MS:-60000}
    depends_on:
      - redis
    restart: unless-stopped

  # Worker para filas
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - N8N_BASE_URL=${N8N_BASE_URL}
      - N8N_WEBHOOK_CAMPAIGN_SEND=${N8N_WEBHOOK_CAMPAIGN_SEND}
      - N8N_WEBHOOK_WHATSAPP_REPLY=${N8N_WEBHOOK_WHATSAPP_REPLY}
      - N8N_WEBHOOK_WHATSAPP_AUTH=${N8N_WEBHOOK_WHATSAPP_AUTH}
      - N8N_WEBHOOK_CREATE_AD_GROUP=${N8N_WEBHOOK_CREATE_AD_GROUP}
      - N8N_WEBHOOK_BILLING=${N8N_WEBHOOK_BILLING}
      - N8N_WEBHOOK_MERCADOPAGO=${N8N_WEBHOOK_MERCADOPAGO}
      - N8N_WEBHOOK_HEALTH=${N8N_WEBHOOK_HEALTH}
      - WHATSAPP_BASE_URL=${WHATSAPP_BASE_URL}
      - WHATSAPP_TOKEN=${WHATSAPP_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - META_APP_ID=${META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
      - META_REDIRECT_URI=${META_REDIRECT_URI}
      - META_LONG_LIVED_TOKEN_SECRET=${META_LONG_LIVED_TOKEN_SECRET}
      - REDIS_URL=redis://redis:6379
      - JWT_SIGNING_KEY=${JWT_SIGNING_KEY}
      - QUEUE_PREFIX=${QUEUE_PREFIX:-ondeclick}
    depends_on:
      - redis
      - backend
    restart: unless-stopped

  # Redis para cache e filas
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  redis_data:
    driver: local
