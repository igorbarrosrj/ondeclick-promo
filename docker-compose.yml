version: '3.8'

services:
  # Frontend Next.js
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "0.0.0.0:3000:3000"
    environment:
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY=${NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY}
      - NODE_ENV=production
    depends_on:
      - backend
      - redis
    restart: unless-stopped
    network_mode: bridge

  # Backend Fastify
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    expose:
      - "4000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-4000}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - N8N_BASE_URL=${N8N_BASE_URL}
      - N8N_WEBHOOK_CAMPAIGN_SEND=${N8N_WEBHOOK_CAMPAIGN_SEND}
      - N8N_WEBHOOK_WHATSAPP_REPLY=${N8N_WEBHOOK_WHATSAPP_REPLY}
      - N8N_WEBHOOK_WHATSAPP_AUTH=${N8N_WEBHOOK_WHATSAPP_AUTH}
      - N8N_WEBHOOK_CREATE_AD_GROUP=${N8N_WEBHOOK_CREATE_AD_GROUP}
      - N8N_WEBHOOK_BILLING=${N8N_WEBHOOK_BILLING}
      - N8N_WEBHOOK_MERCADOPAGO=${N8N_WEBHOOK_MERCADOPAGO}
      - N8N_WEBHOOK_HEALTH=${N8N_WEBHOOK_HEALTH}
      - WHATSAPP_BASE_URL=${WHATSAPP_BASE_URL}
      - WHATSAPP_TOKEN=${WHATSAPP_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_WEBHOOK_VERIFY_TOKEN=${WHATSAPP_WEBHOOK_VERIFY_TOKEN}
      - MERCADOPAGO_ACCESS_TOKEN=${MERCADOPAGO_ACCESS_TOKEN}
      - MERCADOPAGO_PUBLIC_KEY=${MERCADOPAGO_PUBLIC_KEY}
      - MERCADOPAGO_WEBHOOK_SECRET=${MERCADOPAGO_WEBHOOK_SECRET}
      - META_APP_ID=${META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
      - META_REDIRECT_URI=${META_REDIRECT_URI}
      - META_LONG_LIVED_TOKEN_SECRET=${META_LONG_LIVED_TOKEN_SECRET}
      - REDIS_URL=redis://redis:6379
      - JWT_SIGNING_KEY=${JWT_SIGNING_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - QUEUE_PREFIX=${QUEUE_PREFIX:-ondeclick}
      - FEATURE_TIKTOK_ENABLED=${FEATURE_TIKTOK_ENABLED:-false}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-200}
      - RATE_LIMIT_TIME_WINDOW_MS=${RATE_LIMIT_TIME_WINDOW_MS:-60000}
    depends_on:
      - redis
    restart: unless-stopped

  # Worker para filas
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - N8N_BASE_URL=${N8N_BASE_URL}
      - N8N_WEBHOOK_CAMPAIGN_SEND=${N8N_WEBHOOK_CAMPAIGN_SEND}
      - N8N_WEBHOOK_WHATSAPP_REPLY=${N8N_WEBHOOK_WHATSAPP_REPLY}
      - N8N_WEBHOOK_WHATSAPP_AUTH=${N8N_WEBHOOK_WHATSAPP_AUTH}
      - N8N_WEBHOOK_CREATE_AD_GROUP=${N8N_WEBHOOK_CREATE_AD_GROUP}
      - N8N_WEBHOOK_BILLING=${N8N_WEBHOOK_BILLING}
      - N8N_WEBHOOK_MERCADOPAGO=${N8N_WEBHOOK_MERCADOPAGO}
      - N8N_WEBHOOK_HEALTH=${N8N_WEBHOOK_HEALTH}
      - WHATSAPP_BASE_URL=${WHATSAPP_BASE_URL}
      - WHATSAPP_TOKEN=${WHATSAPP_TOKEN}
      - WHATSAPP_PHONE_NUMBER_ID=${WHATSAPP_PHONE_NUMBER_ID}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - META_APP_ID=${META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
      - META_REDIRECT_URI=${META_REDIRECT_URI}
      - META_LONG_LIVED_TOKEN_SECRET=${META_LONG_LIVED_TOKEN_SECRET}
      - REDIS_URL=redis://redis:6379
      - JWT_SIGNING_KEY=${JWT_SIGNING_KEY}
      - QUEUE_PREFIX=${QUEUE_PREFIX:-ondeclick}
    depends_on:
      - redis
      - backend
    restart: unless-stopped

  # Redis para cache e filas
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # Evolution API para WhatsApp
  evolution-api:
    image: atendai/evolution-api:latest
    ports:
      - "8080:8080"
    environment:
      - SERVER_URL=${EVOLUTION_SERVER_URL:-http://localhost:8080}
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - DATABASE_ENABLED=false
      - WEBHOOK_GLOBAL_URL=${EVOLUTION_WEBHOOK_URL}
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
      - CONFIG_SESSION_PHONE_CLIENT=OndeClick Promo
      - QRCODE_LIMIT=30
      - QRCODE_COLOR=#198754
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    restart: unless-stopped
    network_mode: bridge

volumes:
  redis_data:
    driver: local
  evolution_instances:
    driver: local
  evolution_store:
    driver: local
